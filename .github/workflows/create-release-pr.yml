name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Version bump
        id: version
        run: |
          npm version "${{ github.event.inputs.version }}" --no-git-tag-version
      - uses: pnpm/action-setup@v4 # 追加
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm" # 変更

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Version bump
        id: version
        run: |
          pnpm version "${{ github.event.inputs.version }}" --no-git-tag-version
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get release notes
        id: release-notes
        run: |
          DEFAULT_BRANCH=$(gh api "repos/$GITHUB_REPOSITORY" --jq '.default_branch')

          if LAST_TAG=$(gh api "repos/$GITHUB_REPOSITORY/releases/latest" --jq '.tag_name' 2>/dev/null); then
            echo "Previous release: $LAST_TAG"
            RELEASE_NOTES=$(gh api \
              --method POST \
              "/repos/$GITHUB_REPOSITORY/releases/generate-notes" \
              -f "tag_name=v${{ steps.version.outputs.version }}" \
              -f "target_commitish=$DEFAULT_BRANCH" \
              -f "previous_tag_name=$LAST_TAG" \
              --jq '.body')
          else
            echo "First release"
            RELEASE_NOTES="First release of design tokens"
          fi

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: release/v${{ steps.version.outputs.version }}
          delete-branch: true
          title: "Release v${{ steps.version.outputs.version }}"
          body: ${{ env.RELEASE_NOTES }}
          commit-message: "chore: release v${{ steps.version.outputs.version }}"
          labels: "Type: Release"
          draft: true
